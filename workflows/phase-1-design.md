# Phase 1: 设计阶段 (Design Phase)

> 通过苏格拉底式对话澄清需求，探索多种方案，生成经过验证的设计文档。

---

## 目标

1. **理解真实需求**: 通过提问澄清用户意图
2. **探索多种方案**: 对比 2-3 种方案的权衡
3. **生成设计文档**: 经过用户确认的设计规格
4. **建立共同理解**: 确保用户和 Agent 对目标达成一致

---

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        PHASE 1: DESIGN                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户提出需求                                                           │
│       ↓                                                                 │
│   ┌─────────────────┐                                                   │
│   │ 1. 项目上下文检查 │                                                   │
│   │ 检查现有项目状态   │                                                   │
│   │ - 现有文件结构    │                                                   │
│   │ - 技术栈        │                                                    │
│   │ - 架构风格      │                                                    │
│   └────────┬────────┘                                                   │
│            ↓                                                            │
│   ┌─────────────────┐                                                   │
│   │ 2. 需求澄清       │                                                   │
│   │ 苏格拉底式提问    │  ← 一次一个问题                                    │
│   │ - 目标用户是谁？  │  ← 多选题优先                                      │
│   │ - 核心功能？     │                                                    │
│   │ - 约束条件？     │                                                    │
│   │ - 成功标准？     │                                                    │
│   └────────┬────────┘                                                   │
│            ↓                                                            │
│   ┌─────────────────┐                                                   │
│   │ 3. 方案探索       │                                                   │
│   │ 探索 2-3 种方案   │                                                   │
│   │ 方案A: 优缺点    │                                                    │
│   │ 方案B: 优缺点    │                                                    │
│   │ 方案C: 优缺点    │                                                    │
│   │ 推荐方案及理由   │                                                    │
│   └────────┬────────┘                                                   │
│            ↓                                                            │
│   ┌─────────────────┐                                                   │
│   │ 4. 设计展示       │  ← 200-300字/段                                    │
│   │ 增量式展示设计    │  ← 每段用户确认                                     │
│   │ - 架构概览 (段1) │                                                    │
│   │ - 组件设计 (段2) │                                                    │
│   │ - 数据流 (段3)   │                                                    │
│   │ - 错误处理 (段4) │                                                    │
│   └────────┬────────┘                                                   │
│            ↓                                                            │
│   ┌─────────────────┐                                                   │
│   │ 5. 用户确认       │                                                   │
│   │ 用户批准设计      │                                                   │
│   └────────┬────────┘                                                   │
│            ↓                                                            │
│   ┌─────────────────┐                                                   │
│   │ 6. 生成设计文档   │                                                   │
│   │ docs/plans/     │                                                   │
│   │ YYYY-MM-DD-     │                                                   │
│   │ feature-design  │                                                   │
│   │ .md             │                                                   │
│   └────────┬────────┘                                                   │
│            ↓                                                            │
│   Level 1 Gate (设计门禁)                                                │
│   [检查清单](quality-gates.md#level-1-设计门禁)                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 详细步骤

### Step 1: 项目上下文检查

**目的**: 了解现有项目状态，确保设计与现有系统兼容。

**检查内容:**
```bash
# 文件结构
ls -la

# 技术栈检测
if [ -f package.json ]; then echo "Node.js"; fi
if [ -f Cargo.toml ]; then echo "Rust"; fi
if [ -f pyproject.toml ]; then echo "Python"; fi
if [ -f go.mod ]; then echo "Go"; fi

# 架构风格检查
# - 是否有特定架构模式？(MVC, Clean, Hexagonal)
# - 目录结构约定？

# 现有相关代码
# - 是否有类似功能？
# - 可以复用的组件？
```

**输出**: 项目上下文摘要

---

### Step 2: 需求澄清 (苏格拉底式提问)

**原则**: 
- 一次一个问题
- 多选题优先于开放题
- 聚焦"为什么"而非"怎么做"

**问题类别:**

#### 2.1 目标用户
```
这个系统是给谁用的？
A. 个人用户
B. 小团队 (2-10人)
C. 企业团队 (10-100人)
D. 大规模用户 (100+人)
```

#### 2.2 核心功能
```
请列出最重要的 3 个功能，按优先级排序：
1. [功能A]
2. [功能B]  
3. [功能C]

这些是必须有的，还是可以裁剪的？
A. 必须有 (Must have)
B. 应该有 (Should have)
C. 可以有 (Could have)
```

#### 2.3 约束条件
```
有哪些技术约束？
□ 必须使用特定技术栈
□ 必须与现有系统集成
□ 必须符合特定标准
□ 性能要求
□ 安全要求
```

#### 2.4 成功标准
```
怎么衡量这个项目的成功？
- 功能完整度？
- 性能指标？
- 用户满意度？
- 上线时间？
```

**最少问答轮数**: 3 轮

---

### Step 3: 方案探索

**目标**: 探索 2-3 种不同方案，对比权衡。

**每个方案包含:**
- 方案名称
- 架构概述
- 优点
- 缺点
- 适用场景
- 风险

**方案对比表格:**

```markdown
| 维度 | 方案A | 方案B | 方案C |
|------|-------|-------|-------|
| 复杂度 | 低 | 中 | 高 |
| 开发时间 | 2周 | 4周 | 8周 |
| 可扩展性 | 低 | 中 | 高 |
| 维护成本 | 低 | 中 | 高 |
| 技术风险 | 低 | 中 | 高 |
| 推荐度 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
```

**推荐方案说明:**
- 明确推荐哪个方案
- 说明推荐理由
- 指出主要权衡

---

### Step 4: 设计展示 (增量式)

**原则**:
- 每段 200-300 字
- 每段展示后等待用户确认
- 根据反馈调整后续内容

**展示顺序:**

#### 段 1: 架构概览
```
这是一个 [系统类型]，采用 [架构风格]。

核心组件：
- 组件A: 职责
- 组件B: 职责
- 组件C: 职责

技术栈：
- 前端: [技术]
- 后端: [技术]
- 数据库: [技术]

这个架构看起来对吗？
```

#### 段 2: 组件设计
```
组件详细设计：

[组件A]
- 职责: ...
- 接口: ...
- 依赖: ...

[组件B]
...

这个组件划分合理吗？
```

#### 段 3: 数据流
```
主要数据流：

[场景A]
1. 用户操作 → 2. 处理 → 3. 存储 → 4. 响应

[场景B]
...

数据模型：
- EntityA: 字段...
- EntityB: 字段...

这个设计符合你的预期吗？
```

#### 段 4: 错误处理
```
错误处理策略：

[错误场景A]
- 检测方式: ...
- 处理方式: ...
- 用户反馈: ...

[错误场景B]
...

边界情况：
- 情况A: 处理方式
- 情况B: 处理方式

还有其他需要考虑的错误场景吗？
```

---

### Step 5: 用户确认

**确认清单:**
- [ ] 架构设计被确认
- [ ] 组件划分被确认
- [ ] 技术栈被确认
- [ ] 数据流被确认
- [ ] 错误处理被确认
- [ ] 边界情况被确认

**确认方式:**
```
设计总结：
[简洁的设计总结]

请确认：
□ 这个设计满足你的需求
□ 可以开始编写实施计划

有修改意见吗？
```

---

### Step 6: 生成设计文档

**文档路径:**
```
docs/plans/YYYY-MM-DD-<feature-name>-design.md
```

**文档模板:**

```markdown
# [Feature Name] Design

> **Status**: Approved
> **Date**: YYYY-MM-DD
> **Author**: vibe-architect

---

## Goal

[一句话描述目标]

---

## Architecture

[2-3句话描述架构方案]

### System Diagram

```
[架构图]
```

---

## Key Decisions

| Decision | Options | Choice | Reasoning |
|----------|---------|--------|-----------|
| 决策1 | 选项A, B | 选项A | 理由... |
| 决策2 | 选项A, B, C | 选项B | 理由... |

---

## Components

### Component A: [Name]

**Responsibilities:**
- 职责1
- 职责2

**Interface:**
```typescript
interface ComponentA {
  method1(): ReturnType;
  method2(param: Type): ReturnType;
}
```

**Dependencies:**
- 依赖1
- 依赖2

### Component B: [Name]
...

---

## Data Flow

### Flow 1: [Scenario Name]

```
[User] → [Component A] → [Component B] → [Database]
   ↑                                          ↓
   └──────────── [Response] ←─────────────────┘
```

**Steps:**
1. 步骤1
2. 步骤2
3. 步骤3

### Flow 2: [Scenario Name]
...

---

## Data Model

### Entity: [Name]

```typescript
interface Entity {
  id: string;
  field1: Type;
  field2: Type;
  createdAt: Date;
  updatedAt: Date;
}
```

---

## Error Handling

### Error Scenario 1: [Name]

| Aspect | Description |
|--------|-------------|
| Detection | 如何检测 |
| Handling | 如何处理 |
| User Feedback | 用户看到什么 |

### Error Scenario 2: [Name]
...

---

## Testing Strategy

### Unit Tests
- [ ] 组件A的核心逻辑
- [ ] 组件B的边界情况

### Integration Tests
- [ ] 场景A的完整流程
- [ ] 场景B的错误处理

### E2E Tests
- [ ] 用户旅程A
- [ ] 用户旅程B

---

## Open Questions

- [ ] 问题1 (已确认/待确认)
- [ ] 问题2 (已确认/待确认)

---

## Appendix

### Alternative Designs Considered

#### Alternative A
- 优点: ...
- 缺点: ...
- 为什么没选: ...

### References
- 参考文档1
- 参考文档2
```

---

## 质量门禁 (Level 1)

详见 [quality-gates.md#level-1-设计门禁](../quality-gates.md#level-1-设计门禁)

**关键检查点:**
- [ ] 至少 3 轮问答澄清
- [ ] 2-3 种方案已探索
- [ ] 架构图已绘制
- [ ] 用户已确认设计

---

## 常见问题

### Q: 设计阶段需要多长时间？
**A**: 通常 30-60 分钟，取决于项目复杂度。

### Q: 如果用户不确定需求怎么办？
**A**: 继续提问，用多选题帮助用户思考。如果仍然不确定，建议先做原型验证。

### Q: 可以跳过设计阶段直接编码吗？
**A**: 不可以。违反铁律 1。但可以缩短设计阶段，用 [vibe-coding:quick]。

### Q: 设计文档需要多详细？
**A**: 足够详细到可以基于此编写实施计划。通常是高层设计，不包含具体代码。

---

## 与 Superpowers 的对应

| Vibe Coding | Superpowers | 说明 |
|-------------|-------------|------|
| Phase 1: Design | brainstorming skill | 需求澄清、方案探索、增量展示 |

---

**最后更新**: 2026-01-30
**版本**: v2.0
