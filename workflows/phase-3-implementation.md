# Phase 3: 实现阶段 (Implementation Phase)

> 通过子代理驱动或计划执行，完成所有任务的编码实现。

---

## 目标

1. **严格执行 TDD**: 红-绿-重构循环
2. **双阶段审查**: 规格符合性 + 代码质量
3. **任务完成**: 实现计划中的所有任务
4. **质量保证**: 每个任务都通过质量门禁

---

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PHASE 3: IMPLEMENTATION                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   计划文档已通过 Level 2 Gate                                             │
│       ↓                                                                 │
│   选择执行模式:                                                          │
│   ┌─────────────────┐    ┌─────────────────┐                             │
│   │ Mode A:         │    │ Mode B:         │                             │
│   │ Subagent-Driven │    │ Executing Plans │                             │
│   │ 子代理驱动       │    │ 计划执行        │                             │
│   │ (推荐)          │    │ (大项目)        │                             │
│   └────────┬────────┘    └────────┬────────┘                             │
│            │                      │                                     │
│            ↓                      ↓                                     │
│   ┌─────────────────┐    ┌─────────────────┐                             │
│   │ 当前会话执行     │    │ 并行会话执行     │                             │
│   │ 实时交互        │    │ 批量处理        │                             │
│   │ 快速迭代        │    │ 人工检查点      │                             │
│   └─────────────────┘    └─────────────────┘                             │
│                                                                         │
│   本文档描述 Mode A (Subagent-Driven) 流程                               │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Mode A: Subagent-Driven 详细流程                                       │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │ 准备工作                                                         │  │
│   │ 1. 读取计划文档                                                   │  │
│   │ 2. 提取所有任务及上下文                                           │  │
│   │ 3. 创建 TodoWrite 任务列表                                        │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│       ↓                                                                 │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │ 任务循环 (每个 Task)                                             │  │
│   │                                                                 │  │
│   │  ┌─────────────────┐                                           │  │
│   │  │ 1. 派遣实现子代理 │                                           │  │
│   │  │ Implementer     │                                           │  │
│   │  │ Subagent        │                                           │  │
│   │  └────────┬────────┘                                           │  │
│   │           ↓                                                      │  │
│   │  ┌─────────────────┐    ┌─────────────────┐                     │  │
│   │  │ 子代理提问?     │ →  │ 回答并提供      │                     │  │
│   │  │ (可选)          │    │ 更多上下文      │                     │  │
│   │  └─────────────────┘    └─────────────────┘                     │  │
│   │           ↓                                                      │  │
│   │  ┌─────────────────┐                                           │  │
│   │  │ 2. TDD 实现      │                                           │  │
│   │  │ RED: 写失败测试  │                                           │  │
│   │  │ GREEN: 最小代码  │                                           │  │
│   │  │ REFACTOR: 重构   │                                           │  │
│   │  │ COMMIT: 提交     │                                           │  │
│   │  └────────┬────────┘                                           │  │
│   │           ↓                                                      │  │
│   │  ┌─────────────────┐                                           │  │
│   │  │ 3. 派遣规格审查  │                                           │  │
│   │  │ Spec Reviewer   │                                           │  │
│   │  │ Subagent        │                                           │  │
│   │  └────────┬────────┘                                           │  │
│   │           ↓                                                      │  │
│   │     ┌─────┴─────┐                                               │  │
│   │     ▼           ▼                                               │  │
│   │  ┌──────┐   ┌──────┐                                           │  │
│   │  │ ❌   │   │ ✅   │                                           │  │
│   │  │未通过 │   │通过  │                                           │  │
│   │  └──┬───┘   └──┬───┘                                           │  │
│   │     │          ↓                                                │  │
│   │     ↓     ┌─────────────────┐                                  │  │
│   │  返回修复  │ 4. 派遣质量审查  │                                  │  │
│   │          │ Quality Reviewer│                                  │  │
│   │          │ Subagent        │                                  │  │
│   │          └────────┬────────┘                                  │  │
│   │                   ↓                                             │  │
│   │             ┌─────┴─────┐                                      │  │
│   │             ▼           ▼                                      │  │
│   │          ┌──────┐   ┌──────┐                                  │  │
│   │          │ ❌   │   │ ✅   │                                  │  │
│   │          │未通过 │   │通过  │                                  │  │
│   │          └──┬───┘   └──┬───┘                                  │  │
│   │             │          ↓                                       │  │
│   │             ↓     ┌─────────────────┐                         │  │
│   │          返回修复  │ 5. 标记任务完成  │                         │  │
│   │                   │ Update TodoWrite│                         │  │
│   │                   └─────────────────┘                         │  │
│   │                                                                │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│       ↓                                                                 │
│   更多任务?                                                             │
│   ┌─────┐ 是    ┌─────┐ 否                                             │
│   │  是  │ →    │  否  │ → 所有任务完成                                │
│   └─────┘       └─────┘                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 准备工作

### 1. 读取计划文档

```bash
# 读取计划
cat docs/plans/YYYY-MM-DD-feature-plan.md

# 提取任务数量
grep "^### Task" docs/plans/... | wc -l
```

### 2. 创建任务列表

```markdown
## Implementation Progress

### Task 1: [Name]
- [ ] Implement
- [ ] Spec Review
- [ ] Quality Review
- [ ] Complete

### Task 2: [Name]
...
```

---

## 任务执行循环

### Step 1: 派遣实现子代理

**子代理 Prompt 模板:**

```
你是一名专业的实现工程师，负责完成以下任务。

## 任务信息

**任务编号:** Task N
**任务名称:** [Name]
**所属项目:** [Project]

## 上下文

**设计文档:** [link]
**计划文档:** [link]
**已完成任务:** [list]

**场景设置:**
[Context from plan - 帮助理解任务背景]

## 你的职责

1. 如有疑问，先提问澄清
2. 严格遵循 TDD:
   - 先写测试，看失败
   - 写最小代码通过测试
   - 重构，保持测试绿色
   - 提交
3. 自审查代码
4. 报告完成

## 任务详情

[Full task text from plan]

## 铁律提醒

- NO PRODUCTION CODE WITHOUT A FAILING TEST FIRST
- 违反 = 删除代码，重新开始
- YAGNI: 不多写一行代码

开始吧。如有问题请提问，否则开始实现。
```

### Step 2: TDD 实现

**子代理必须遵循:**

#### RED (写失败测试)
```typescript
// 1. 写测试
test('rejects empty email', () => {
  expect(() => validateEmail(''))
    .toThrow('Email is required');
});

// 2. 运行看失败
// npm test
// Expected: FAIL - "validateEmail is not defined"
```

#### GREEN (最小代码)
```typescript
// 3. 写最小代码
export function validateEmail(email: string) {
  if (!email) {
    throw new Error('Email is required');
  }
}

// 4. 运行看通过
// npm test
// Expected: PASS
```

#### REFACTOR (重构)
```typescript
// 5. 重构 (如有必要)
// - 消除重复
// - 改进命名
// - 保持测试绿色
```

#### COMMIT (提交)
```bash
# 6. 提交
git add .
git commit -m "feat: add email validation

- Validate email is not empty
- Throw descriptive error message

Tests: 1 passing"
```

### Step 3: 规格符合性审查

**审查子代理 Prompt:**

```
你是一名规格符合性审查员。审查以下实现是否符合计划。

## 审查对象

**任务:** Task N - [Name]
**实现者:** [Implementer subagent]

## 计划要求

[Task specification from plan]

## 实现代码

[Code implemented]

## 审查清单

- [ ] 实现了计划中的所有要求
- [ ] 没有过度实现 (YAGNI)
- [ ] 边界情况已处理
- [ ] 错误处理完整
- [ ] 接口符合设计

## 输出格式

### 结果: [通过/未通过]

### 发现的问题
| 严重度 | 问题 | 位置 | 建议 |
|--------|------|------|------|
| Critical/Important | 描述 | 文件:行 | 修复建议 |

### 肯定之处
- 实现得好的地方
```

**处理方式:**
- ✅ 通过 → 进入 Stage 2 (质量审查)
- ❌ 未通过 → 返回实现子代理修复 → 重新审查

### Step 4: 代码质量审查

**审查子代理 Prompt:**

```
你是一名代码质量审查员。审查以下代码的质量。

## 审查对象

**任务:** Task N - [Name]
**代码:** [Code and tests]

## 审查清单

### 测试质量
- [ ] 测试可读
- [ ] 测试名称清晰
- [ ] 测试行为而非实现
- [ ] 覆盖率充分

### 代码风格
- [ ] 命名规范
- [ ] 格式一致
- [ ] 注释适当

### 安全
- [ ] 输入验证
- [ ] 无注入风险
- [ ] 错误处理安全

### 设计
- [ ] SOLID 原则
- [ ] 关注点分离
- [ ] 无重复代码

## 输出格式

### 结果: [通过/未通过]

### 发现的问题
| 严重度 | 问题 | 位置 | 建议 |
|--------|------|------|------|
| Critical/Important/Suggestion | 描述 | 文件:行 | 修复建议 |

### 肯定之处
- 代码质量好的地方
```

**处理方式:**
- ✅ 通过 → 标记任务完成
- ❌ 未通过 → 返回实现子代理修复 → 重新审查

### Step 5: 标记任务完成

```markdown
### Task N: [Name]
- [x] Implement
- [x] Spec Review
- [x] Quality Review
- [x] Complete ✅

**提交:** [commit hash]
**耗时:** X minutes
```

---

## 双阶段审查规则

### 规则 1: 顺序不可颠倒

```
❌ 错误: 同时做两个阶段
❌ 错误: 先做质量审查再做规格审查

✅ 正确: 规格审查 → (通过) → 质量审查
```

### 规则 2: 未通过必须修复

```
审查发现问题的处理:

1. 记录问题
2. 返回实现子代理
3. 子代理修复
4. 重新审查 (同一个审查员类型)
5. 直到通过
```

### 规则 3: 问题分级处理

| 级别 | 处理方式 |
|------|---------|
| Critical | 必须修复，阻塞任务完成 |
| Important | 应该修复，可记录为技术债务 |
| Suggestion | 可选，不阻塞 |

---

## 完成标准

### 所有任务完成时:

```markdown
## Implementation Complete ✅

### 统计
- 总任务数: N
- 完成时间: X 小时
- 代码提交: N 次

### 质量指标
- 规格审查通过率: X%
- 质量审查通过率: X%
- 平均审查轮数: X

### 提交历史
[git log --oneline]

### 下一步
进入 Phase 4: Quality Phase
```

---

## 常见问题

### Q: 一个任务需要多长时间？
**A**: 实现 2-5 分钟 + 两轮审查各 1-2 分钟 = 5-10 分钟/任务

### Q: 子代理提问怎么处理？
**A**: 回答并提供更多上下文。这是好事，说明子代理在理解需求。

### Q: 可以并行执行多个任务吗？
**A**: 不可以。子代理可能冲突。串行执行，但审查可优化。

### Q: 如果子代理无法实现任务？
**A**: 分析原因：
- 任务太大？→ 拆分为更小的任务
- 需求不清？→ 返回 Phase 1 澄清
- 技术障碍？→ 调整技术方案

---

## 与 Superpowers 的对应

| Vibe Coding | Superpowers | 说明 |
|-------------|-------------|------|
| Mode A | subagent-driven-development skill | 子代理驱动开发 |
| Mode B | executing-plans skill | 批量计划执行 |
| TDD | test-driven-development skill | 测试驱动开发 |

---

**最后更新**: 2026-01-30
**版本**: v2.0
